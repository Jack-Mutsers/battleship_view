@page
@model battleship_view.JoinSessionModel
@using Entities.Models;
@{
    ViewData["Title"] = "JoinSession";
}

<div class="container">
    <main role="main" class="pb-3">
        <link rel="stylesheet" type="text/css" href="~/css/JoinSession.css">

        <h1>JoinSession</h1>

        <div class="content">
            <a id="back" class="btn btn-outline-dark" asp-area="" onclick="window.history.go(-1); return false;">Back</a>
            <div id="join" class="box">
                <div class="field">
                    <p>
                        Username:
                    </p>

                    <input id="username-input" type="text" />
                </div>
                <div class="field">
                    <p>
                        Lobbycode:
                    </p>

                    <input id="lobbycode-input" type="text" />
                </div>
                <div class="join-container">
                    <button onclick="JoinSession();" class="join">Join lobby</button>
                </div>
            </div>


            <div id="lobby" class="left-side">
                <div id="username" class="field">
                    <p>
                        Username:
                    </p>
                </div>
                <div id="lobbycode" class="field">
                    <p>
                        Lobbycode:
                    </p>
                </div>
                <div class="leave-container">
                    <a class="nav-link text-dark leave" asp-area="" asp-page="/JoinSession">Leave lobby</a>
                </div>
            </div>

            <table id="playerTable" class="hidden right-side">
                <thead>
                    <tr class="">
                        <th class="tableHeader">order number</th>
                        <th class="tableHeader">name</th>
                    </tr>
                </thead>
                <tbody id="players">
                </tbody>
            </table>

            <a class="btn btn-outline-dark" asp-area="" asp-page="/CreateField">go to create field</a>
        </div>

        <script>

            function JoinSession() {
                var name = $("#username-input").val();
                var sessionCode = $("#lobbycode-input").val();

                $.ajax({
                    type: "Get",
                    url: "JoinSession?handler=JoinHost&&name=" + name + "&&sessionCode=" + sessionCode
                });

                $("#playerTable").removeClass("hidden");
                CheckForChanges();
            }

            function CheckForChanges() {
                $.ajax({
                    type: "GET",
                    url: "JoinSession?handler=ChangeChecker",
                    contentType: 'application/json; charset=utf-8',
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert("Request: " + XMLHttpRequest.toString() + "\n\nStatus: " + textStatus + "\n\nError: " + errorThrown);
                    },
                    success: function (result) {
                        UpdatePlayers(result);
                    },
                    complete: function () {
                        setTimeout(CheckForChanges, 3000);
                    }
                });
            }

            function UpdatePlayers(players) {

                $("#players").html("");

                $.each(players, function (key, player) {
                    console.log(player);
                    $("#players").append("<tr><td>" + player.orderNumber + "</td><td>" + player.name + "</td></tr>");
                });
            }

        </script>

    </main>
</div>